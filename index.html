
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mapa semi√≥tico</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#111; --ink:#eaeaea; --muted:#9aa0a6;
    --red:#ef4444; --green:#22c55e; --blue:#38bdf8; --accent:#a78bfa; --sel:#f59e0b;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--ink); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  .wrap{display:grid; grid-template-columns: 460px 1fr; gap:16px; padding:16px; box-sizing:border-box; height:100%;}
  .card{background:var(--panel); border:1px solid #1e1e1e; border-radius:16px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  h1{font-size:18px; margin:0 0 8px}
  h2{font-size:14px; margin:16px 0 8px; color:var(--muted); font-weight:600; letter-spacing:.2px}
  label{display:block; margin:10px 0 4px}
  input[type="text"]{width:100%; padding:8px 10px; border-radius:10px; border:1px solid #2a2a2a; background:#0e0e0f; color:var(--ink)}
  input[type="range"]{width:100%}
  input[type="file"]{width:100%}
  .row{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center}
  .row2{display:grid; grid-template-columns: 1fr 1fr; gap:8px; align-items:center}
  .pill{display:inline-flex; align-items:center; gap:8px; background:#0e0e10; padding:6px 10px; border-radius:999px; border:1px solid #232323; color:var(--muted)}
  .btn{appearance:none; background:#1f2937; border:none; color:white; padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#5b21b6,#4c1d95);}
  .legend{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px}
  .legend span{display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:#121214; border:1px solid #242424}
  .dot{width:10px;height:10px;border-radius:50%}
  .list{max-height:30vh; overflow:auto; border-top:1px dashed #2a2a2a; margin-top:8px; padding-top:8px}
  .item{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #222}
  .item:last-child{border-bottom:none}
  .small{font-size:12px; color:var(--muted)}
  #viz{height:100%; position:relative}
  svg{width:100%; height:100%; background:#000;}
  .badge{font-size:11px; color:#ddd; background:#222; border:1px solid #333; padding:2px 6px; border-radius:999px;}
  .lock{margin-left:8px; font-size:12px; color:#ddd; background:#2b2b2b; border:1px solid #3a3a3a; border-radius:10px; padding:4px 8px}
  .dropHint{margin-top:8px; padding:8px; border:1px dashed #333; border-radius:10px; color:#cbd5e1; background:#0e0e12}
  .selected{filter: drop-shadow(0 0 0.75rem rgba(245,158,11,.6));}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <h1>Mapa semi√≥tico interactivo</h1>
    <div class="small">Sliders 1‚Äì100 (lineal). Calibraci√≥n manual. **Carga autom√°tica** del fondo <b>diagrama_p.png</b>. Exporta PNG con valores.</div>

    <h2>Fondo</h2>
    <div class="row">
      <label>Selecciona archivo (recomendado para exportar)</label>
      <span class="pill small">PNG/JPG</span>
    </div>
    <input id="bgFile" type="file" accept="image/*" />
    <div class="row">
      <label>Ruta (se usa por defecto)</label>
      <span class="pill small">diagrama_p.png</span>
    </div>
    <input id="bgPath" type="text" value="diagrama_p.png" />
    <div class="row2" style="margin-top:6px">
      <button class="btn" id="loadBtn">Cargar fondo</button>
      <button class="btn" id="exportBtn">Exportar PNG</button>
    </div>

    <h2>Calibraci√≥n manual</h2>
    <div class="row2">
      <button class="btn" id="toggleCalib">Calibraci√≥n: ACTIVADA</button>
      <button class="btn" id="hideLabels">Ocultar/mostrar etiquetas</button>
    </div>
    <div class="small">Coords atractores: <span id="coords"></span></div>

    <h2>Nuevo elemento</h2>
    <label>Nombre</label>
    <input id="name" type="text" placeholder="Ej.: Afiche de campa√±a" />

    <div class="row">
      <label>√çcono</label>
      <span class="pill"><span style="background:var(--red);width:8px;height:8px;border-radius:50%;display:inline-block"></span><span id="iconoVal">50</span>/100</span>
    </div>
    <input id="icono" type="range" min="1" max="100" step="1" value="50" oninput="iconoVal.textContent=this.value; liveUpdateSelected();" />

    <div class="row">
      <label>√çndice</label>
      <span class="pill"><span style="background:var(--green);width:8px;height:8px;border-radius:50%;display:inline-block"></span><span id="indiceVal">50</span>/100</span>
    </div>
    <input id="indice" type="range" min="1" max="100" step="1" value="50" oninput="indiceVal.textContent=this.value; liveUpdateSelected();" />

    <div class="row">
      <label>S√≠mbolo</label>
      <span class="pill"><span style="background:var(--blue);width:8px;height:8px;border-radius:50%;display:inline-block"></span><span id="simboloVal">50</span>/100</span>
    </div>
    <input id="simbolo" type="range" min="1" max="100" step="1" value="50" oninput="simboloVal.textContent=this.value; liveUpdateSelected();" />

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="addBtn">Agregar punto</button>
      <button class="btn" id="clearBtn">Limpiar</button>
    </div>

    <h2>Elementos</h2>
    <div class="list" id="list"></div>

    <div class="dropHint">üí° Arrastra y suelta im√°genes (JPG/PNG) encima del gr√°fico. Miniaturas rectangulares.</div>
  </section>

  <section class="card" id="viz">
    <div class="legend">
      <span><span class="dot" style="background:var(--red)"></span>√çcono</span>
      <span><span class="dot" style="background:var(--green)"></span>√çndice</span>
      <span><span class="dot" style="background:var(--blue)"></span>S√≠mbolo</span>
      <span class="badge">Arrastra puntos/im√°genes ‚Ä¢ Bloquear ‚Ä¢ Renombrar</span>
    </div>

    <svg id="svg" viewBox="0 0 1080 768" xmlns="http://www.w3.org/2000/svg">
      <image id="bgImg" href="" x="0" y="0" width="1080" height="768" preserveAspectRatio="xMidYMid meet"></image>
      <g id="pointsLayer"></g>
      <g id="attractors" fill="#eee" stroke="#000" stroke-width="0.5">
        <g id="A_icono" cursor="grab"><circle r="8" fill="var(--red)"></circle><text y="-18" style="display:none">√çcono</text></g>
        <g id="A_indice" cursor="grab"><circle r="8" fill="var(--green)"></circle><text y="-18" style="display:none">√çndice</text></g>
        <g id="A_simbolo" cursor="grab"><circle r="8" fill="var(--blue)"></circle><text y="26" style="display:none">S√≠mbolo</text></g>
      </g>
    </svg>
  </section>
</div>

<script>
let W=1080, H=768;
const svg = document.getElementById('svg');
const bgImg = document.getElementById('bgImg');
const pointsLayer = document.getElementById('pointsLayer');

let calibMode = true;
// Al inicio, ocultamos etiquetas para evitar "flash" de texto grande
let labelsVisible = false;
let selectedId = null;

// Atractores relativos
let A = {icono:{x:0.25,y:0.30}, indice:{x:0.75,y:0.30}, simbolo:{x:0.50,y:0.92}};

const $ = id => document.getElementById(id);
function abs(Arel){return {icono:{x:Arel.icono.x*W,y:Arel.icono.y*H}, indice:{x:Arel.indice.x*W,y:Arel.indice.y*H}, simbolo:{x:Arel.simbolo.x*W,y:Arel.simbolo.y*H}};}
function updateAttractors(){
  const a = abs(A);
  $('A_icono').setAttribute('transform',`translate(${a.icono.x},${a.icono.y})`);
  $('A_indice').setAttribute('transform',`translate(${a.indice.x},${a.indice.y})`);
  $('A_simbolo').setAttribute('transform',`translate(${a.simbolo.x},${a.simbolo.y})`);
  $('coords').textContent = `√çcono (${a.icono.x.toFixed(0)}, ${a.icono.y.toFixed(0)}) ¬∑ √çndice (${a.indice.x.toFixed(0)}, ${a.indice.y.toFixed(0)}) ¬∑ S√≠mbolo (${a.simbolo.x.toFixed(0)}, ${a.simbolo.y.toFixed(0)})`;
}
function setSVGSize(nw, nh){
  W=nw; H=nh; svg.setAttribute('viewBox',`0 0 ${W} ${H}`); bgImg.setAttribute('width',W); bgImg.setAttribute('height',H);
  updateAttractors(); redraw();
}

// Carga de fondo desde archivo
document.getElementById('bgFile').addEventListener('change', (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ev =>{
    const data = ev.target.result;
    const img = new Image();
    img.onload = ()=>{ setSVGSize(img.naturalWidth||1080, img.naturalHeight||768); bgImg.setAttribute('href', data); showLabels(); };
    img.src = data;
  };
  r.readAsDataURL(file);
});
// Carga de fondo desde ruta
function loadFromPath(path){
  const img = new Image();
  img.onload = ()=>{ setSVGSize(img.naturalWidth||1080, img.naturalHeight||768); bgImg.setAttribute('href', path); showLabels(); };
  img.onerror = ()=> console.warn('No se pudo cargar el fondo desde ruta:', path);
  img.src = path + '?t=' + Date.now();
}
document.getElementById('loadBtn').addEventListener('click', ()=>{
  const path = $('bgPath').value.trim(); if(!path) return;
  loadFromPath(path);
});

function showLabels(){
  labelsVisible = true;
  ['A_icono','A_indice','A_simbolo'].forEach(id=>{ document.querySelector(`#${id} text`).style.display = 'inline'; });
}
document.getElementById('hideLabels').addEventListener('click', ()=>{
  labelsVisible = !labelsVisible;
  ['A_icono','A_indice','A_simbolo'].forEach(id=>{
    document.querySelector(`#${id} text`).style.display = labelsVisible ? 'inline' : 'none';
  });
});
document.getElementById('toggleCalib').addEventListener('click', ()=>{
  calibMode = !calibMode;
  $('toggleCalib').textContent = 'Calibraci√≥n: ' + (calibMode? 'ACTIVADA' : 'DESACTIVADA');
});

// Drag de atractores
for(const [gid,key] of [['A_icono','icono'],['A_indice','indice'],['A_simbolo','simbolo']]){
  const g = $(gid); let dragging=false;
  g.addEventListener('mousedown', e=>{ if(!calibMode) return; dragging=true; g.style.cursor='grabbing'; });
  window.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const p = pt.matrixTransform(svg.getScreenCTM().inverse());
    const x = Math.max(0,Math.min(W,p.x)), y=Math.max(0,Math.min(H,p.y));
    g.setAttribute('transform',`translate(${x},${y})`);
    A[key] = {x:x/W, y:y/H};
    updateAttractors();
    points.forEach(pnt=>{ const pos = computeFromSliders(pnt.icono, pnt.indice, pnt.simbolo); pnt.x=pos.x; pnt.y=pos.y; });
    redraw();
  });
  window.addEventListener('mouseup', ()=>{ dragging=false; g.style.cursor='grab'; });
}

// Modelo lineal
function computeFromSliders(icono, indice, simbolo){
  const a = abs(A);
  const wI = Math.max(icono,1), wD = Math.max(indice,1), wS = Math.max(simbolo,1);
  const sum = wI + wD + wS;
  const x = (wI*a.icono.x + wD*a.indice.x + wS*a.simbolo.x)/sum;
  const y = (wI*a.icono.y + wD*a.indice.y + wS*a.simbolo.y)/sum;
  return {x,y};
}
function slidersFromPosition(x,y){
  const a = abs(A);
  const P = {x,y}, A0=a.icono, A1=a.indice, A2=a.simbolo;
  const v0={x:A1.x-A0.x, y:A1.y-A0.y}, v1={x:A2.x-A0.x, y:A2.y-A0.y}, v2={x:P.x-A0.x, y:P.y-A0.y};
  const d00=v0.x*v0.x+v0.y*v0.y, d01=v0.x*v1.x+v0.y*v1.y, d11=v1.x*v1.x+v1.y*v1.y;
  const d20=v2.x*v0.x+v2.y*v0.y, d21=v2.x*v1.x+v2.y*v1.y;
  const denom = d00*d11 - d01*d01 || 1e-6;
  let v = (d11*d20 - d01*d21)/denom;
  let w = (d00*d21 - d01*d20)/denom;
  let u = 1 - v - w;
  u = Math.max(0, Math.min(1, u)); v = Math.max(0, Math.min(1, v)); w = Math.max(0, Math.min(1, w));
  const s = u+v+w || 1; u/=s; v/=s; w/=s;
  const map = t => Math.min(100, Math.max(1, Math.round(1 + t*99)));
  return { icono: map(u), indice: map(v), simbolo: map(w) };
}

// Puntos / Im√°genes
let points = []; // {id, name, icono, indice, simbolo, x, y, locked, imgSrc?, size}
function liveUpdateSelected(){
  if(!selectedId) return;
  const p = points.find(q=>q.id===selectedId); if(!p) return;
  p.name = $('name').value.trim() || p.name;
  p.icono = +$('icono').value; p.indice= +$('indice').value; p.simbolo= +$('simbolo').value;
  const pos = computeFromSliders(p.icono, p.indice, p.simbolo);
  p.x=pos.x; p.y=pos.y;
  redraw(); renderList();
}

$('addBtn').addEventListener('click', ()=>{
  const name = $('name').value.trim() || 'Sin t√≠tulo';
  const icono=+$('icono').value, indice=+$('indice').value, simbolo=+$('simbolo').value;
  const pos = computeFromSliders(icono, indice, simbolo);
  const id = crypto.randomUUID();
  points.push({id, name, icono, indice, simbolo, x:pos.x, y:pos.y, locked:false, size:36});
  selectedId = id;
  redraw(); renderList();
});
$('clearBtn').addEventListener('click', ()=>{ points=[]; selectedId=null; redraw(); renderList(); });

function makePointGroup(p){
  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.setAttribute("transform",`translate(${p.x},${p.y})`);
  g.style.cursor = p.locked ? 'not-allowed' : 'grab';
  if(selectedId===p.id) g.classList.add('selected');

  if(p.imgSrc){
    const s = p.size || 36;
    const img = document.createElementNS("http://www.w3.org/2000/svg","image");
    img.setAttribute('href', p.imgSrc);
    img.setAttribute('x', -s); img.setAttribute('y', -s);
    img.setAttribute('width', s*2); img.setAttribute('height', s*2);
    g.appendChild(img);
    const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
    rect.setAttribute('x', -s); rect.setAttribute('y', -s);
    rect.setAttribute('width', s*2); rect.setAttribute('height', s*2);
    rect.setAttribute('fill', 'none'); rect.setAttribute('stroke', '#fff'); rect.setAttribute('stroke-width', '1');
    g.appendChild(rect);
  } else {
    const halo = document.createElementNS("http://www.w3.org/2000/svg","rect");
    halo.setAttribute("x",-12); halo.setAttribute("y",-12); halo.setAttribute("width",24); halo.setAttribute("height",24);
    halo.setAttribute("fill","rgba(167,139,250,.25)");
    halo.setAttribute("stroke","var(--accent)"); halo.setAttribute("stroke-width","1.5");
    g.appendChild(halo);
  }

  const nameT = document.createElementNS("http://www.w3.org/2000/svg","text");
  nameT.textContent = p.name + (p.locked?' üîí':'');
  nameT.setAttribute("y", -(p.size||12) - 12);
  nameT.setAttribute("text-anchor","middle");
  nameT.setAttribute("fill","#eaeaea"); nameT.setAttribute("font-size","12");
  nameT.setAttribute("stroke","#000"); nameT.setAttribute("stroke-width","0.5");
  g.appendChild(nameT);

  const valsT = document.createElementNS("http://www.w3.org/2000/svg","text");
  valsT.textContent = `ico(${p.icono}) ind(${p.indice}) sim(${p.simbolo})`;
  valsT.setAttribute("y", (p.size||12) + 14);
  valsT.setAttribute("text-anchor","middle");
  valsT.setAttribute("fill","#eaeaea"); valsT.setAttribute("font-size","11");
  valsT.setAttribute("stroke","#000"); valsT.setAttribute("stroke-width","0.5");
  g.appendChild(valsT);

  g.addEventListener('click', (e)=>{
    selectedId = p.id;
    const s = slidersFromPosition(p.x, p.y);
    $('icono').value=s.icono; $('iconoVal').textContent=s.icono;
    $('indice').value=s.indice; $('indiceVal').textContent=s.indice;
    $('simbolo').value=s.simbolo; $('simboloVal').textContent=s.simbolo;
    $('name').value = p.name;
    renderList(); redraw();
    e.stopPropagation();
  });

  let dragging=false;
  g.addEventListener('mousedown', ()=>{ if(p.locked) return; dragging=true; g.style.cursor='grabbing'; selectedId=p.id; });
  window.addEventListener('mousemove', (e)=>{
    if(!dragging) return;
    const pt = svg.createSVGPoint(); pt.x=e.clientX; pt.y=e.clientY;
    const q = pt.matrixTransform(svg.getScreenCTM().inverse());
    p.x = Math.max(0, Math.min(W, q.x)); p.y = Math.max(0, Math.min(H, q.y));
    g.setAttribute("transform",`translate(${p.x},${p.y})`);
    const s = slidersFromPosition(p.x, p.y);
    p.icono=s.icono; p.indice=s.indice; p.simbolo=s.simbolo;
    $('icono').value=s.icono; $('iconoVal').textContent=s.icono;
    $('indice').value=s.indice; $('indiceVal').textContent=s.indice;
    $('simbolo').value=s.simbolo; $('simboloVal').textContent=s.simbolo;
    $('name').value = p.name;
    valsT.textContent = `ico(${p.icono}) ind(${p.indice}) sim(${p.simbolo})`;
    renderList();
  });
  window.addEventListener('mouseup', ()=>{ dragging=false; g.style.cursor=p.locked?'not-allowed':'grab'; });

  return g;
}

function redraw(){
  while(pointsLayer.firstChild) pointsLayer.removeChild(pointsLayer.firstChild);
  for(const p of points){ pointsLayer.appendChild(makePointGroup(p)); }
}

function renderList(){
  const list = $('list'); list.innerHTML='';
  for(const p of points){
    const div = document.createElement('div'); div.className='item';
    const left = document.createElement('div');
    left.innerHTML = `<b>${p.name}</b> <span class="lock">${p.locked?'Bloqueado':'Libre'}</span>
      <div class="small">ico(${p.icono}) ¬∑ ind(${p.indice}) ¬∑ sim(${p.simbolo})${p.imgSrc ? ' ¬∑ img':''}</div>`;
    const right = document.createElement('div');
    const renameBtn = document.createElement('button'); renameBtn.className='btn'; renameBtn.textContent='Renombrar';
    const lockBtn = document.createElement('button'); lockBtn.className='btn'; lockBtn.textContent = p.locked?'Desbloquear':'Bloquear';
    const sizeMinus = document.createElement('button'); sizeMinus.className='btn'; sizeMinus.textContent='‚àí';
    const sizePlus = document.createElement('button'); sizePlus.className='btn'; sizePlus.textContent='+';
    sizePlus.style.marginLeft='6px';
    const del = document.createElement('button'); del.className='btn'; del.textContent='Eliminar'; del.style.marginLeft='6px';
    right.append(renameBtn, lockBtn, sizeMinus, sizePlus, del);
    div.append(left, right);
    list.appendChild(div);

    renameBtn.onclick = ()=>{
      const nuevo = prompt('Nuevo nombre', p.name);
      if(nuevo){ p.name = nuevo; if(selectedId===p.id) $('name').value = nuevo; redraw(); renderList(); }
    };
    lockBtn.onclick = ()=>{ p.locked=!p.locked; redraw(); renderList(); };
    sizeMinus.onclick = ()=>{ p.size = Math.max(12, (p.size||36)-4); redraw(); };
    sizePlus.onclick = ()=>{ p.size = Math.min(160, (p.size||36)+4); redraw(); };
    del.onclick = ()=>{ points = points.filter(q=>q!==p); if(selectedId===p.id) selectedId=null; redraw(); renderList(); };

    left.onclick = ()=>{
      selectedId = p.id;
      const s = slidersFromPosition(p.x, p.y);
      $('icono').value=s.icono; $('iconoVal').textContent=s.icono;
      $('indice').value=s.indice; $('indiceVal').textContent=s.indice;
      $('simbolo').value=s.simbolo; $('simboloVal').textContent=s.simbolo;
      $('name').value=p.name;
      redraw();
    };
  }
}

// Export PNG
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const serializer = new XMLSerializer();
  const str = serializer.serializeToString(svg);
  const blob = new Blob([str], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas'); canvas.width=W; canvas.height=H;
    const ctx = canvas.getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0,0,canvas.width,canvas.height);
    const png = canvas.toDataURL('image/png');
    const a = document.createElement('a'); a.href=png; a.download='mapa_semiotico.png'; a.click();
    URL.revokeObjectURL(url);
  };
  img.src = url;
});

// Drag&Drop de im√°genes
const vizCard = document.getElementById('viz');
['dragenter','dragover'].forEach(ev=>vizCard.addEventListener(ev, e=>{ e.preventDefault(); e.dataTransfer.dropEffect='copy'; }));
vizCard.addEventListener('drop', e=>{
  e.preventDefault();
  const files = [...(e.dataTransfer.files||[])].filter(f=>/^image\//.test(f.type));
  if(!files.length) return;
  const pt = svg.createSVGPoint(); pt.x = e.clientX; pt.y = e.clientY;
  const drop = pt.matrixTransform(svg.getScreenCTM().inverse());
  files.forEach(file=>{
    const reader = new FileReader();
    reader.onload = ev => {
      const id = crypto.randomUUID();
      const name = file.name.replace(/\.[^.]+$/, '');
      const s = slidersFromPosition(Math.max(0,Math.min(W,drop.x)), Math.max(0,Math.min(H,drop.y)));
      const pos = computeFromSliders(s.icono, s.indice, s.simbolo);
      points.push({id, name, icono:s.icono, indice:s.indice, simbolo:s.simbolo, x:pos.x, y:pos.y, locked:false, imgSrc:ev.target.result, size:36});
      selectedId = id; redraw(); renderList();
    };
    reader.readAsDataURL(file);
  });
});

// Init: auto-cargar diagrama_p.png
(function init(){
  const def = 'diagrama_p.png';
  document.getElementById('bgPath').value = def;
  loadFromPath(def);
})();
</script>
</body>
</html>
